<h2 mat-dialog-title class="dialog-title">
    Detalle de Presupuesto
</h2>

<mat-dialog-content class="dialog-content">

    <!-- ✅ Cabecera -->
    <div class="section">
        <div class="subTitle">Información del Presupuesto</div>

        <div class="info-grid">

            <div class="info-card">
                <div class="info-label">Código</div>
                <div class="info-value">{{ budget?.code || '—' }}</div>
            </div>

            <div class="info-card">
                <div class="info-label">Estado</div>

                <div class="info-value">
                    <span class="chip activo" *ngIf="budget?.isApproved">Aprobado</span>
                    <span class="chip suspendido" *ngIf="!budget?.isApproved">Pendiente</span>
                </div>
            </div>

            <div class="info-card">
                <div class="info-label">Oficial</div>
                <div class="info-value">
                    <span class="chip multi" *ngIf="budget?.isOfficial">OFICIAL</span>
                    <span *ngIf="!budget?.isOfficial" style="color: gray;">Histórico</span>
                </div>
            </div>

            <div class="info-card">
                <div class="info-label">Fecha</div>
                <div class="info-value">{{ budget?.createdAt | date:'dd/MM/yyyy HH:mm' }}</div>
            </div>

        </div>
    </div>

    <div class="form-grid">
        <div class="form-field full" style="margin-bottom: 12px;">
            <label class="label">Notas / Observaciones</label>

            <textarea class="textarea" rows="3"
                placeholder="Ej: descuento aplicado, diagnóstico, condiciones del cliente..." [(ngModel)]="budget.notes"
                disabled>
                    </textarea>
        </div>
    </div>


    <!-- ✅ Tabla items -->
    <div class="section">
        <div class="subTitle">Items</div>

        <div class="table-container">
            <div class="table-scroll">
                <div class="table-body detail-table">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Descripción</th>
                                <th>Cant.</th>
                                <th>Precio Unit.</th>
                                <th>Descuento</th>
                                <th>Total</th>
                                <th>Aprobar</th>
                            </tr>
                        </thead>

                        <tbody>
                            <tr *ngFor="let it of budget?.items">

                                <td>
                                    <span class="chip type-product" *ngIf="it.itemType === 1">Producto</span>
                                    <span class="chip type-service" *ngIf="it.itemType === 2">Servicio</span>
                                </td>

                                <td>
                                    <div class="item-title">
                                        {{ it.product?.name || it.service?.name }}
                                    </div>
                                </td>

                                <td><input class="input-mini" type="number" min="1" [disabled]="it.isApproved"
                                        [(ngModel)]="it.quantity" (ngModelChange)="recalcItem(it)" /></td>

                                <td><input class="input-mini" type="number" min="0" [disabled]="it.isApproved"
                                        [(ngModel)]="it.unitPrice" (ngModelChange)="recalcItem(it)" /></td>

                                <!-- ✅ DESCUENTO -->
                                <td>
                                    <input class="input-mini" type="number" min="0" [disabled]="it.isApproved"
                                        [(ngModel)]="it.discount" (ngModelChange)="recalcItem(it)" />
                                </td>

                                <!-- ✅ TOTAL -->
                                <td>
                                    <strong>{{ it.totalPrice | currency:'PEN':'symbol':'1.2-2' }}</strong>

                                    <div *ngIf="it.discount > 0" class="discount-label">
                                        Descuento aplicado
                                    </div>
                                </td>

                                <!-- ✅ APROBAR -->
                                <td>
                                    <!-- <input type="checkbox" [(ngModel)]="it.isApproved"  /> -->
                                    <mat-checkbox [(ngModel)]="it.isApproved"
                                        (change)="toggleApprove(it)"></mat-checkbox>
                                </td>

                            </tr>

                            <tr *ngIf="!budget?.items || budget?.items?.length === 0">
                                <td colspan="5" class="empty-row">
                                    No hay items registrados
                                </td>
                            </tr>
                        </tbody>

                    </table>
                </div>
            </div>
        </div>

        <!-- ✅ Totales -->
        <div class="total-box">
            <div class="total-label">TOTAL</div>
            <div class="total-value">{{ budget?.total | currency:'PEN':'symbol':'1.2-2' }}</div>
        </div>

    </div>

</mat-dialog-content>

<mat-dialog-actions class="dialog-actions" align="end">

    <button class="btn-cancelar" (click)="cancelar()">Cerrar</button>

    <button class="btn-primary" (click)="aprobar()">
        Guardar Aprobaciones
    </button>

</mat-dialog-actions>